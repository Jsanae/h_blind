\documentclass[varwidth]{standalone}
\usepackage{amsmath}
\usepackage{mathtools}
\begin{document}
Let $C^k_i$ be the colour of pixel $i$ on image $k$.\\
$X^k_{ij} =
\left\{
\begin{matrix}
1 & \text{, if } C^k_i > C^k_j\\
0 & \text{, if } C^k_i = C^k_j\\
-1 & \text{, if } C^k_i < C^k_j
\end{matrix}\right.$\\
$Y_{ij} = \frac{\sum^B_k X^k_{ij}}{B}$\\
And let's make temporary assumption that $C^k_j$ are iid on $\{0, 1, ..., 255\}$. (random picture model*)\\
That's wrong assumption, but we will claim that for a while to get better understanding.\\
Let $p_l = Pr(X^k_{ij} = l)$
(now we quietly assume that this probability is equal for any $k$, $i$, $j$)\\
For a random* picture we have:\\
$p_0 = \frac{1}{256}$\\
$p_1 = p_{-1} = \frac{1-p_0}{2} = \frac{255}{512}$\\
$E(X^k_{ij}) = 1\cdot p_1 + 0\cdot p_0 + (-1)\cdot p_{-1}$\\
$E(Y_{ij}) = 0$\\
$Var(Y_{ij}) = \frac{Var(X^1_{ij})}{B} = \frac{p_1 + p_{-1}}{B} = \frac{255}{256\cdot B}$\\
Now let's see how $Y_{ij}$ behaves when input is watermarked random* pictures with the same watermark. We have $C'^k = C^k + w$ as input.\\
In case $w_i > w_j$ then\\
$X^k_{ij} =
\left\{
\begin{matrix}
1 & \text{, if } C^k_i + w_i > C^k_j + w_j\\
0 & \text{, if } C^k_i + w_i = C^k_j + w_j\\
-1 & \text{, if } C^k_i + w_i < C^k_j + w_j
\end{matrix}\right.$\\
\begin{align*}
p_1 &= Pr(X^k_{ij} = 1) = Pr(C^k_i + w_i > C^k_j + w_j) =\\
    &= Pr(C^k_i + 2 > C^k_j) =\\
    &= \sum_{l=0}^{255} Pr(C^k_i + 2 > C^k_j | C^k_j = l)Pr(C^k_j = l) =\\
    &= (1 + \sum_{i=1}^{255} \frac{257-i}{256})\cdot \frac{1}{256} =\\
    &= (1 + \frac{1}{256}\cdot \frac{258\cdot 255}{2})\cdot \frac{1}{256}=\frac{33151}{65536}
        \approx 0.506\\
p_0 &= Pr(C^k_i + 2 = C^k_j) = \sum_{l=0}^{255} Pr(C^k_i + 2 = C^k_j | C^k_j = l)\frac{1}{256}\\
    &= \sum_{l=2}^{255} Pr(C^k_i + 2 = C^k_j | C^k_j = l)\cdot \frac{1}{256}\\
    &= \frac{254}{65536} \approx 0.004\\
p_{-1} &= \frac{32131}{65536} \approx 0.49
\end{align*}\\
So the expected value and the variance are equal to:
\begin{align*}
E(Y_{ij}) &= E(X^k_{ij}) = p_1 - p_{-1}=\frac{255}{256}\cdot \frac{1}{64}\\
Var(Y_{ij}) &= \frac{Var(X^k_{ij})}{B}\\
            &= \frac{p_1(1-p_1+p_{-1})^2 + p_0(p_1-p_{-1})^2 + p_{-1}(1+p_1-p_{-1})^2}{B}\\
            &= \frac{p_1 + p_{-1} + p_1^3 + p_{-1}^3 - p_1^2p_{-1} - p_1p_{-1}^2 + p_0(p_1-p_{-1})^2}{B}\\
            &= \frac{p_1 + p_{-1} + (p_1-p_{-1})^2}{B}\\
            &\approx \frac{0.996}{B}
\end{align*}
In case $w_i = w_j$ then\\
\begin{align*}
p_0 &= \frac{1}{256}\\
p_1 &= p_{-1} = \frac{1-p_0}{2} = \frac{255}{512}\\
E(Y_{ij}) &= 0\\
Var(Y_{ij}) &= \frac{p_1 + p_{-1} + (p_1-p_{-1})^2}{B} = \frac{255}{256\cdot B} \approx \frac{0.996}{B}
\end{align*}
In case $w_i < w_j$ then\\
\begin{align*}
E(Y_{ij}) &= -\frac{255}{256}\cdot \frac{1}{64}\\
Var(Y_{ij}) &= \frac{p_1 + p_{-1} + (p_1-p_{-1})^2}{B} \approx \frac{0.996}{B}
\end{align*}
Having the expected values of $Y_{ij}$ computed we obtained a natural predicate
that will tell us how the edge model should look like. Basically, we will
claim:\\
$delta(i, j) = \left\{
  \begin{matrix*}[l]
    2&\text{, if } Y_{ij} < -\tau\\
    0&\text{, if } -\tau <= Y_{ij} <= \tau\\
    -2&\text{, if } \tau < Y_{ij}
  \end{matrix*}\right.$ , where $\tau = \frac{p_1 - p_{-1}}{2}$\\
Now, it is crucial to figure out how good is the predicate. To get this we will
compute $Pr(|Y_{ij} - E(Y_{ij})| >= \tau)$. If it is small then the edge model
is approximated well. Let's apply Chebyshev inequality:
$$
Pr(|Y_{ij} - E(Y_{ij})| \geq \tau)
  \leq \frac{Var(Y_{ij})}{\tau^2}
  \leq \frac{1}{B\tau^2}
  = \frac{256\cdot 256\cdot 128\cdot 128}{255\cdot 255\cdot B}
$$
, so if $B > 166000$ then $Pr(|Y_{ij} - E(Y_{ij})| >= \tau) <= 0.1$.
\end{document}
